<div id="store_container">
    <script id="store_template" type="x-tmpl-mustache/text">
        <div class="main_banner text-center">
            <h2>{{name}}</h2>
            <p>EXPLORE • ENJOY • SHOP</p>
        </div>
        <div class="main_container content_container">
            <div class="store_list_head">
                <div class="row">
                    <div class="col-md-12 store_top">
                        <h5 class="back_btn show_phone"><i class="fa fa-angle-left" aria-hidden="true"></i> <a href="/stores" class="store_anchors active_heading">Back to Stores</a></h5>
                        <span class="soft_hidden_phone store_anchors active_heading"><i class="fa fa-angle-left" aria-hidden="true"></i> <a href="/stores">Back to Stores</a></span>
                        <div class="store_details_anchors pull-right">
                            <a id="promo_anchor" href="#promos_main" class="store_anchors active_heading">
                                Promotions (<span></span>)
                            </a>
                            <a id="job_anchor" href="#jobs_main" class="store_anchors active_heading">
                                Careers (<span></span>)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="margin_25_across">
                <div class="row">
                    <div class="col-md-8">
                        <div class="details_desc">
                            {{ #store_front_alt_url_abs }}
                            <img class="margin_20 img-responsive" style="{{show_store_front}}" src="{{store_front_alt_url_abs}}" alt="{{name}} Store Front" />
                            {{ /store_front_alt_url_abs }}
                            <div class=" store_desc">
                                <div class="margin_20">{{{rich_description}}}</div>
                            </div>
                            <div class="side_stores show_phone">
                                <a class="animated_btn newsletter_btn" href="tel:{{phone}}" style="{{phone_show}}">
                                    Phone: {{phone}}
                                </a>
                                <a class="animated_btn newsletter_btn" href="http://{{website}}" target="_blank" style="{{show}}">
                                    Website
                                </a>
                            </div>
                            // <div class="map-container">
                            //     <div class="mapsvg_store_detail"></div>
                            // </div>
                            <iframe src="https://mf-map.netlify.com/map?iframe=true&staging=true&subdomain=aberdeen&hideStoreList=true" frameborder="0" width="100%" height="100%" id="iFrame1" sandbox="allow-top-navigation allow-scripts allow-same-origin"></iframe>
                            <img id="IE_map" src="">
                        </div>
                    </div>
                    <div class="col-md-4 hidden_phone">
                        <img class="margin_20 store_logo center-block hidden_phone" src="{{store_front_url_abs}}" alt="{{name}}"/>
                        <div class="side_stores">
                            <a class="animated_btn newsletter_btn" href="tel:{{phone}}" style="{{phone_show}}">
                                Phone: {{phone}}
                            </a>
                            <a class="animated_btn newsletter_btn" href="http://{{website}}" target="_blank" style="{{show}}">
                                Website
                            </a>
                        </div>
                    </div> 
                </div>
            </div>
        </div>
    </script>
</div>
<div class="main_container content_container">
    <div class="margin_25_across">
        <div class="row">
            <div class="col-md-8 promo_item" id="promos_main">
                <h2 class="store_details_promo_heading">Promotions</h2>
                <div id="promos_container">
                    <script id="promos_template" type="x-tmpl-mustache/text">
                        <div class="row promo_item">
                            <div class="col-sm-4">
                                <img class="promo_store_image" src="{{promo_image_url_abs}}" alt="{{name}}" />
                            </div>
                            <div class="col-sm-8">
                                <h2 class="promo_list_name">{{name}}</h2>
                                <p>
                                    <span class="promo_dates">{{dates}}</span>
                                </p>
                                <div class="promo_list_desc">{{description_short}}</div>
                                <a class="read_more" href="/promotions/{{slug}}">See Promotion Details <i class="fa fa-angle-right"></i></a>
                            </div>
                        </div>
                    </script>
                </div>
            </div>
            <div class="col-md-8 promo_item" id="jobs_main">
                <h2 class="store_details_promo_heading">Careers</h2>
                <div id="jobs_container">
                    <script id="jobs_template" type="x-tmpl-mustache/text">
                        <div class="row promo_item">
                            <div class="col-md-3">
                                <div class="cropped_image">
                                    <img src="{{img_url}}" alt="{{store_name}} Logo" />
                                </div>
                            </div>
                            <div class="col-md-9">
                                <h2 class="promo_list_name">{{name}}</h2>
                                <p>
                                    <span class="promo_store">{{job_type}}</span><span class="hidden_phone"> | </span>
                                    <span class="promo_dates">End Date: {{end_date}}</span>
                                </p>
                                <div class="promo_list_desc">{{description_short}}</div>
                                <a class="read_more" href="/jobs/{{slug}}">View Posting Details <i class="fa fa-angle-right"></i></a>
                            </div>
                        </div>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
<!--<script src="//codecloud.cdn.speedyrails.net/sites/5a9eeaa46e6f6405fb150000/text/javascript/1520365246170/mapplic_mmsdk.js"></script>-->
<script src="//codecloud.cdn.speedyrails.net/sites/59bac7db6e6f644f22ba0000/text/javascript/1484859750000/hammer.min.js"></script>

<script>
    $(document).ready(function(e){
        init(e);
        function renderAll (){
            var pathArray = window.location.pathname.split( '/' );
            var slug = pathArray[pathArray.length-1];
            var store_details = getStoreDetailsBySlug(slug);
            if (store_details === undefined){
                window.location = "/";
            } else {
                renderStoreDetails("#store_container","#store_template", store_details, slug);
                
                //PROMOS
                var store_promo_ids = store_details.promotions
                var store_promos = getPromotionsForIds(store_promo_ids).sortBy(function(o){ return o.start_date });
                var published_promos = [];
                $.each( store_promos , function( key, val ){
                    today = moment();
                    webDate = moment(val.show_on_web_date);
                    if (today >= webDate) {
                        published_promos.push(val)
                    } 
                });
                if( published_promos.length > 0){
                    renderPromotions("#promos_container","#promos_template", published_promos);
                    $('#promo_anchor span').text(published_promos.length)
                } else {
                    $('#promos_main').hide()
                    $('#promo_anchor').hide()
                }
                
                // JOBS
                var store_job_ids = store_details.jobs
                var store_jobs = getJobsForIds(store_job_ids).sortBy(function(o){ return o.start_date });
                var published_jobs = [];
                $.each( store_jobs , function( key, val ){
                    today = moment();
                    webDate = moment(val.show_on_web_date);
                    if (today >= webDate) {
                        published_jobs.push(val)
                    } 
                });
                if( published_jobs.length > 0){
                    renderJobs('#jobs_container', '#jobs_template', published_jobs);
                    $('#job_anchor span').text(published_jobs.length)
                } else {
                    $('#jobs_main').hide();
                    $('#job_anchor').hide()
                }
                
                var svg_width = 1080;
                var svg_height = 1224;
                //MAP  
                var stores = getStoresList();
                var mall_json = {};
                var landmarks = {};
                mall_json.mapwidth = svg_width;
                mall_json.mapheight = svg_height;
                mall_json.categories = [];
                mall_json.levels = [];
    
                // need to add the following for each floor we want to configure.
                _.forEach(floorList(), function(value, key) {
                    var floor_1 = {};
                    floor_1.id = value.id;
                    floor_1.title = value.title;
                    floor_1.map = value.map;
                    floor_1.show = value.show;
                    floor_1.locations = [];
                    var stores_on_floors= [];
                    if( value.z_index == null) {
                        stores_on_floors = stores;
                    } else {
                        stores_on_floors = _.filter(stores, function(o) { if(o.z_coordinate == null) {return true;} else { return value.z_index === o.z_coordinate; }});
                    }
                    _.forEach(stores_on_floors, function(val, key) {
                        //for testing limiting the store numbers to vm
                        var temp_val = {};
                        temp_val.id = val.id;
                        temp_val.title = val.name;
                        temp_val.about = val.description.substring(0, 200);
                        if (val.categories != null) {
                            if (val.categories.length > 1) {
                                temp_val.category = val.categories[1];
                            } else {
                                temp_val.category = val.categories[0];
                            }
                        }
                        temp_val.zoom = 2;
                        temp_val.link = "/stores/" + val.slug;
                        temp_val.pin = "hidden";
    
                        //get svg's width/height by checking the map
                        
                        temp_val.x = val.x_coordinate / svg_width;
                        temp_val.y = val.y_coordinate / svg_height;
                        
                        // temp_val.zoom = "5";
                        floor_1.locations.push(temp_val);
                    });
                    mall_json.levels.push(floor_1);
                });
                
                map = $('.mapsvg_store_detail').mapplic({
                    source: mall_json,
                    height: 400,
                    landmark: true,
                    mapfill: true,
                    minimap: false,
                    sidebar: false,
                    hovertip: true,
                    developer: false,
                    fullscreen: false,
                    clearbutton: false,
                    deeplinking: false,
                    fillcolor: "none",
                    maxscale: 1,
                    skin: 'mapplic-dark',
                    action: "tooltip"
                });
    
                map.on('mapready', function(e, self) {
                    self.showLocation(store_details.id);
                });
            }
        }
      
        loadMallDataCached(renderAll);
        
        show_content();
        // Enhanced map code
        $('#iFrame1').css('display','block')
        console.log('IE ' + detectIE());
        if(detectIE()){
            var svg_url = '//mallmaverickstaging.com'+getPropertyDetails().svgmap_url;
            $('#iFrame1').remove();
            $("#IE_map").attr("src", svg_url)
        } else {
            $('#IE_map').remove();
        }
        // loadMallDataCached(renderAll); 
    });
        // Enhanced map code
    window.addEventListener('message', function(event) {
        // IMPORTANT: check the origin of the data! 
        if (event.origin.startsWith('https://mf-map.netlify.com') && event.data.event === "store-details-clicked") { 
            // The data was sent from your site.
            // Data sent with postMessage is stored in event.data:
            if(event.data && event.data.selectedStore) {
                var store = event.data.selectedStore
                window.location.href= "/stores/"+store.slug
            }
        } else if (event.origin.startsWith('https://mf-map.netlify.com') && event.data.event === "map-loaded") {
            if(event.data) {
                var loading = event.data.loading;
                if (!loading){
                    let frame = document.getElementById('iFrame1');
                    frame.contentWindow.postMessage({ event: "select-store", selectedStore: store_details }, '*');
                }
            }
        }
    });
    function detectIE() {
        var ua = window.navigator.userAgent;
    
        var msie = ua.indexOf('MSIE ');
        if (msie > 0) {
            // IE 10 or older => return version number
            return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
        }
    
        var trident = ua.indexOf('Trident/');
        if (trident > 0) {
            // IE 11 => return version number
            var rv = ua.indexOf('rv:');
            return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
        }
    
        var edge = ua.indexOf('Edge/');
        if (edge > 0) {
           // Edge (IE 12+) => return version number
           return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
        }
    
        // other browser
        return false;
    }
</script>

<style>
    html, iframe{
        scroll-behavior: smooth;
        height: calc(100% - 101px) !important;
        top: 101px !important;
    }
    #IE_map{
        margin:auto;
        height:400px;
    }
    #iFrame1 {
        display: none;
        min-height: 500px;
    }
    @media (max-width: 768px) {
    #iFrame1 {
        display: none;
        min-height: 400px;
    }
    }
</style>
<!--<style>-->
<!--    .mapplic-popup-link, .mapplic-tooltip-close {-->
<!--        display:none!important;-->
<!--    }-->
<!--</style>-->